FROM python:3.10-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    POSTGRES_USER=lendahand \
    POSTGRES_PASSWORD=lendahand \
    POSTGRES_DB=lendahand_test \
    PGDATA=/var/lib/postgresql/data

ARG STRIPE_MOCK_VERSION=""

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    wget \
    xz-utils \
    golang \
    postgresql \
    postgresql-contrib \
    libpq-dev \
    gcc \
    && rm -rf /var/lib/apt/lists/*

RUN mkdir -p /var/lib/postgresql/data /var/run/postgresql /tmp/minio-data && \
    chown -R postgres:postgres /var/lib/postgresql /var/run/postgresql

RUN set -eux; \
    curl -fsSL "https://dl.min.io/server/minio/release/linux-amd64/minio" -o /usr/local/bin/minio && \
    chmod +x /usr/local/bin/minio && \
    curl -fsSL "https://dl.min.io/client/mc/release/linux-amd64/mc" -o /usr/local/bin/mc && \
    chmod +x /usr/local/bin/mc && \
    CGO_ENABLED=0 GOBIN=/usr/local/bin GO111MODULE=on go install "github.com/stripe/stripe-mock@${STRIPE_MOCK_VERSION:-latest}"

WORKDIR /app

COPY backend /app/backend

RUN pip install --upgrade pip && \
    pip install -r /app/backend/requirements.txt && \
    pip install pytest pytest-django pytest-cov

COPY backend/test /app/backend/test

RUN chmod +x /app/backend/test/*.sh

WORKDIR /app/backend

ENTRYPOINT ["bash", "test/run_tests.sh"]
