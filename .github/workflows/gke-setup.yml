name: GKE Setup

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to setup'
        required: true
        type: choice
        options:
          - dev
          - prod

jobs:
  setup-gke:
    name: Setup GKE Cluster
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ github.event.inputs.environment == 'dev' && secrets.GCP_SA_KEY_DEV || secrets.GCP_SA_KEY_PROD }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ github.event.inputs.environment == 'dev' && secrets.GCP_PROJECT_ID_DEV || secrets.GCP_PROJECT_ID_PROD }}
      
      - name: Set variables
        id: vars
        run: |
          if [ "${{ github.event.inputs.environment }}" == "dev" ]; then
            echo "PROJECT_ID=${{ secrets.GCP_PROJECT_ID_DEV }}" >> $GITHUB_OUTPUT
            echo "CLUSTER_NAME=${{ secrets.GKE_CLUSTER_NAME_DEV }}" >> $GITHUB_OUTPUT
            echo "LOCATION=${{ secrets.GKE_LOCATION_DEV }}" >> $GITHUB_OUTPUT
          else
            echo "PROJECT_ID=${{ secrets.GCP_PROJECT_ID_PROD }}" >> $GITHUB_OUTPUT
            echo "CLUSTER_NAME=${{ secrets.GKE_CLUSTER_NAME_PROD }}" >> $GITHUB_OUTPUT
            echo "LOCATION=${{ secrets.GKE_LOCATION_PROD }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Enable required APIs
        run: |
          gcloud services enable \
            container.googleapis.com \
            compute.googleapis.com \
            cloudresourcemanager.googleapis.com \
            artifactregistry.googleapis.com
      
      - name: Check if cluster exists
        id: cluster-check
        run: |
          if gcloud container clusters describe ${{ steps.vars.outputs.CLUSTER_NAME }} \
            --zone=${{ steps.vars.outputs.LOCATION }} \
            --project=${{ steps.vars.outputs.PROJECT_ID }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Cluster already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Cluster does not exist"
          fi
        continue-on-error: true
      
      - name: Create GKE cluster
        if: steps.cluster-check.outputs.exists != 'true'
        run: |
          gcloud container clusters create ${{ steps.vars.outputs.CLUSTER_NAME }} \
            --project=${{ steps.vars.outputs.PROJECT_ID }} \
            --zone=${{ steps.vars.outputs.LOCATION }} \
            --machine-type=e2-medium \
            --num-nodes=2 \
            --enable-autoscaling \
            --min-nodes=1 \
            --max-nodes=5 \
            --enable-autorepair \
            --enable-autoupgrade \
            --enable-ip-alias \
            --network=default \
            --subnetwork=default \
            --addons=HorizontalPodAutoscaling,HttpLoadBalancing \
            --release-channel=regular
      
      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials ${{ steps.vars.outputs.CLUSTER_NAME }} \
            --zone=${{ steps.vars.outputs.LOCATION }} \
            --project=${{ steps.vars.outputs.PROJECT_ID }}
      
      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes
      
      - name: Create namespaces
        run: |
          kubectl create namespace lendahand-${{ github.event.inputs.environment }} --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'
      
      - name: Install Helm dependencies
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update
          helm dependency build devops/lendahand

